# Redis Production Configuration for Blyan Network
# Security-hardened configuration with TLS and authentication

################################## NETWORK #####################################

# Accept connections only from localhost by default
# In production, update to private network IP
bind 127.0.0.1 ::1

# Protected mode prevents external connections without auth
protected-mode yes

# Port 0 disables TCP, use Unix socket for local connections
port 0

# Unix socket for local connections (faster, more secure)
unixsocket /var/run/redis/redis.sock
unixsocketperm 770

# TCP backlog for high load
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

################################# TLS/SSL ######################################

# Enable TLS port
tls-port 6379

# Configure TLS/SSL certificates
tls-cert-file /etc/redis/certs/redis.crt
tls-key-file /etc/redis/certs/redis.key

# Configure DH params for perfect forward secrecy
tls-dh-params-file /etc/redis/certs/redis.dh

# Configure CA certificate
tls-ca-cert-file /etc/redis/certs/ca.crt

# Require client certificates (mutual TLS)
tls-auth-clients yes

# TLS protocols (only modern protocols)
tls-protocols "TLSv1.2 TLSv1.3"

# Cipher suites (only strong ciphers)
tls-ciphers "HIGH:!aNULL:!MD5"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256"

# Prefer server cipher order
tls-prefer-server-ciphers yes

################################# GENERAL ######################################

# Run as daemon
daemonize no

# Set server verbosity to 'notice' in production
loglevel notice

# Log file location
logfile /var/log/redis/redis-server.log

# Set the number of databases
databases 16

################################## SECURITY ####################################

# Require password for all operations
requirepass ${REDIS_PASSWORD}

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_dks83jd9"  # Rename instead of disable
rename-command SHUTDOWN "SHUTDOWN_xks92ms0"

# ACL configuration for fine-grained access control
aclfile /etc/redis/users.acl

################################### LIMITS #####################################

# Max clients
maxclients 10000

# Max memory with eviction policy
maxmemory 2gb
maxmemory-policy allkeys-lru

# Memory sampling
maxmemory-samples 5

################################# PERSISTENCE ##################################

# RDB snapshots
save 900 1      # After 900 sec (15 min) if at least 1 key changed
save 300 10     # After 300 sec (5 min) if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# Compress RDB
rdbcompression yes
rdbchecksum yes

# The filename for RDB
dbfilename dump.rdb

# The working directory for RDB and AOF
dir /var/lib/redis

# AOF persistence
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

################################## SLOW LOG ####################################

# Slow log for monitoring
slowlog-log-slower-than 10000
slowlog-max-len 128

################################ LATENCY MONITOR ###############################

# Latency monitoring
latency-monitor-threshold 100

################################## SECURITY ####################################

# Protected mode
protected-mode yes

# Disable potentially dangerous commands
enable-protected-configs no
enable-debug-command no
enable-module-command no