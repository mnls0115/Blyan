<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="communityTitle">커뮤니티</title>
  <link rel="stylesheet" href="components.css" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .community-container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
    .post-editor { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .post-editor input, .post-editor textarea { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
    .post-editor button { background: var(--primary-color); color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .post-card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 16px; border-left: 4px solid var(--primary-color); }
    .post-meta { color: #6b7280; font-size: 12px; margin-top: 6px; }
    .post-actions { display: flex; gap: 10px; margin-top: 8px; }
    .post-actions button { background: #f3f4f6; border: 1px solid #e5e7eb; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .comments { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; }
    .comment { padding: 8px 0; border-bottom: 1px dashed #e5e7eb; }
    .reply { margin-left: 16px; }
    .comment-input { display: flex; gap: 8px; margin-top: 10px; }
    .comment-input textarea { flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; }
    .comment-input button { padding: 8px 12px; border: none; background: var(--secondary-color); color: #fff; border-radius: 8px; cursor: pointer; }
    .toolbar { display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; }
    .toolbar .right { display:flex; gap:8px; }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn.primary { background: var(--primary-color); color:#fff; border:none; }
  </style>
  <script src="language.js"></script>
  <script src="config.js"></script>
  <script src="metamask_auth.js"></script>
  <script src="common-header.js"></script>
  <script>
    let auth;
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('header-container').innerHTML = createAIBlockHeader('community');
      updatePageLanguage();

      auth = new BlyanAuth();
      const authed = await auth.checkAuth();
      if (!authed) {
        // Show connect CTA
        document.getElementById('connect-warning').style.display = 'block';
      }

      // default: show list, editor hidden
      document.getElementById('post-editor').style.display = 'none';
      await loadPosts();

      // toolbar buttons
      document.getElementById('writeBtn').addEventListener('click', () => toggleEditor(true));
      document.getElementById('cancelWriteBtn').addEventListener('click', () => toggleEditor(false));
      document.getElementById('publishBtn').addEventListener('click', async () => {
        if (!(await auth.checkAuth())) { alert('지갑을 먼저 연결해 주세요.'); return; }
        await createPost();
        toggleEditor(false);
      });
    });

    async function api(path, opts = {}) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      const token = localStorage.getItem('blyan_token');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_CONFIG.baseURL + path, Object.assign({}, opts, { headers }));
      if (!res.ok) {
        let detail = 'Request failed';
        try { const j = await res.json(); detail = j.detail || JSON.stringify(j); } catch {}
        throw new Error(detail);
      }
      return res.json();
    }

    async function loadPosts() {
      const list = await api('/community/posts');
      const container = document.getElementById('posts');
      container.innerHTML = '';
      list.forEach(post => container.appendChild(renderPost(post)));
    }

    function toggleEditor(show) {
      const editor = document.getElementById('post-editor');
      editor.style.display = show ? 'block' : 'none';
      if (show) {
        document.getElementById('postTitle').focus();
      } else {
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
      }
    }

    function renderPost(post) {
      const el = document.createElement('div');
      el.className = 'post-card';
      const anon = post.author_address.slice(0, 6) + '...' + post.author_address.slice(-4);
      el.innerHTML = `
        <div class="post-title" style="font-weight:700; font-size:16px;">${escapeHtml(post.title)}</div>
        <div class="post-content" style="white-space:pre-wrap; margin-top:6px;">${escapeHtml(post.content)}</div>
        <div class="post-meta">by ${anon} · ${new Date(post.created_at).toLocaleString()}</div>
        <div class="post-actions">
          <button data-action="like">${post.liked_by_me ? t('unlike') : t('like')} (${post.like_count})</button>
          <button data-action="toggle-comments">${t('comments')} (${post.comment_count})</button>
        </div>
        <div class="comments" style="display:none;"></div>
      `;

      const likeBtn = el.querySelector('[data-action="like"]');
      likeBtn.addEventListener('click', async () => {
        if (!(await auth.checkAuth())) { alert('로그인이 필요합니다'); return; }
        const data = await api(`/community/posts/${post.id}/like`, { method: 'POST' });
        likeBtn.textContent = (data.liked ? t('unlike') : t('like')) + ` (${data.like_count})`;
      });

      const commentsContainer = el.querySelector('.comments');
      const toggleBtn = el.querySelector('[data-action="toggle-comments"]');
      toggleBtn.addEventListener('click', async () => {
        if (commentsContainer.style.display === 'none') {
          commentsContainer.style.display = 'block';
          await loadComments(post.id, commentsContainer);
        } else {
          commentsContainer.style.display = 'none';
        }
      });

      return el;
    }

    async function loadComments(postId, container) {
      const comments = await api(`/community/posts/${postId}/comments`);
      container.innerHTML = '';
      container.appendChild(renderCommentInput(postId, null));
      const tree = buildCommentTree(comments);
      tree.forEach(node => container.appendChild(renderCommentNode(node, postId)));
    }

    function buildCommentTree(items) {
      const byId = new Map();
      items.forEach(c => { byId.set(c.id, Object.assign({ children: [] }, c)); });
      const roots = [];
      items.forEach(c => {
        if (c.parent_comment_id) {
          const parent = byId.get(c.parent_comment_id);
          if (parent) parent.children.push(byId.get(c.id));
          else roots.push(byId.get(c.id));
        } else {
          roots.push(byId.get(c.id));
        }
      });
      return roots;
    }

    function renderCommentNode(node, postId, depth = 0) {
      const el = document.createElement('div');
      el.className = 'comment' + (depth > 0 ? ' reply' : '');
      const anon = node.author_address.slice(0, 6) + '...' + node.author_address.slice(-4);
      el.innerHTML = `
        <div style="font-size:13px; color:#374151; white-space:pre-wrap;">${escapeHtml(node.content)}</div>
        <div class="post-meta">${anon} · ${new Date(node.created_at).toLocaleString()}</div>
        <div class="post-actions"><button data-action="reply">${t('reply')}</button></div>
      `;
      const replyBtn = el.querySelector('[data-action="reply"]');
      replyBtn.addEventListener('click', () => {
        const input = renderCommentInput(postId, node.id);
        el.appendChild(input);
      });
      if (node.children && node.children.length) {
        node.children.forEach(child => el.appendChild(renderCommentNode(child, postId, depth + 1)));
      }
      return el;
    }

    function renderCommentInput(postId, parentId) {
      const wrap = document.createElement('div');
      wrap.className = 'comment-input';
      wrap.innerHTML = `
        <textarea rows="2" placeholder="${t('addComment')}"></textarea>
        <button>${t('publish')}</button>
      `;
      const btn = wrap.querySelector('button');
      btn.addEventListener('click', async () => {
        const content = wrap.querySelector('textarea').value.trim();
        if (!content) return;
        if (!(await auth.checkAuth())) { alert('로그인이 필요합니다'); return; }
        await api(`/community/posts/${postId}/comments`, {
          method: 'POST',
          body: JSON.stringify({ content, parent_comment_id: parentId })
        });
        // Reload comments section
        const container = wrap.parentElement;
        await loadComments(postId, container);
      });
      return wrap;
    }

    async function createPost() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      if (!title || !content) return;
      await api('/community/posts', { method: 'POST', body: JSON.stringify({ title, content }) });
      await loadPosts();
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"]+/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
    }
  </script>
</head>
<body>
  <div id="header-container"></div>

  <div class="community-container">
    <div class="toolbar">
      <div style="font-weight:700; font-size:18px;" data-i18n="communityTitle">커뮤니티</div>
      <div class="right">
        <button id="writeBtn" class="btn primary" data-i18n="writePost">글쓰기</button>
      </div>
    </div>

    <div id="connect-warning" class="post-editor" style="display:none; background:#fff7ed; border-left:4px solid #f59e0b;">
      <div style="color:#92400e;">지갑을 연결하면 글과 댓글을 쓸 수 있습니다.</div>
    </div>

    <div id="post-editor" class="post-editor">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:700;" data-i18n="newPost">새 글</div>
        <div>
          <button id="cancelWriteBtn" class="btn" style="margin-right:8px;" data-i18n="cancel">취소</button>
          <button id="publishBtn" class="btn primary" data-i18n="publish">게시</button>
        </div>
      </div>
      <input id="postTitle" type="text" data-i18n-placeholder="postTitlePlaceholder" placeholder="제목" />
      <textarea id="postContent" rows="4" data-i18n-placeholder="postContentPlaceholder" placeholder="내용을 입력하세요..."></textarea>
    </div>

    <div id="posts"></div>
  </div>
</body>
</html>

