<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribution Dashboard - Blyan Network</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            color: #9ca3af;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: #667eea;
        }
        
        .stat-label {
            color: #9ca3af;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 0.9rem;
            color: #10b981;
        }
        
        .stat-change.negative {
            color: #ef4444;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            color: #9ca3af;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }
        
        .leaderboard td {
            padding: 15px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .leaderboard tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .rank {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2rem;
        }
        
        .rank.gold {
            color: #fbbf24;
        }
        
        .rank.silver {
            color: #cbd5e1;
        }
        
        .rank.bronze {
            color: #f97316;
        }
        
        .address {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #e0e0e0;
        }
        
        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .contribution-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .contribution-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .contribution-info {
            flex: 1;
        }
        
        .contribution-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .type-dataset {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .type-inference {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .type-learning {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }
        
        .type-validation {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .contribution-description {
            color: #e0e0e0;
            margin-bottom: 5px;
        }
        
        .contribution-time {
            color: #9ca3af;
            font-size: 0.85rem;
        }
        
        .contribution-reward {
            text-align: right;
        }
        
        .reward-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 5px;
        }
        
        .reward-label {
            color: #9ca3af;
            font-size: 0.85rem;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .refresh-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-stats {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .user-address-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-family: 'Monaco', monospace;
            margin-bottom: 15px;
        }
        
        .user-address-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üèÜ Contribution Dashboard</h1>
            <p>Track your contributions and rewards in the Blyan Network</p>
        </div>
        
        <!-- Global Stats -->
        <div class="stats-grid" id="globalStats">
            <div class="stat-card">
                <div class="stat-label">Total Distributed (24h)</div>
                <div class="stat-value" id="dailyTotal">0</div>
                <div class="stat-change">+0% from yesterday</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Contributors</div>
                <div class="stat-value" id="activeContributors">0</div>
                <div class="stat-change">+0 new today</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Datasets Submitted</div>
                <div class="stat-value" id="datasetsCount">0</div>
                <div class="stat-change">+0 validated</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg PoDL Score</div>
                <div class="stat-value" id="avgPodlScore">0.000</div>
                <div class="stat-change">Quality improving</div>
            </div>
        </div>
        
        <!-- User Stats -->
        <div class="section user-stats">
            <div class="section-title">
                Your Statistics
                <button class="refresh-btn" onclick="refreshData()">Refresh</button>
            </div>
            <input 
                type="text" 
                class="user-address-input" 
                id="userAddress"
                placeholder="Enter your wallet address (0x...)"
                onchange="loadUserStats()"
            >
            <div id="userStatsContent">
                <p style="color: #9ca3af;">Enter your wallet address to view your statistics</p>
            </div>
        </div>
        
        <!-- Leaderboard -->
        <div class="section">
            <div class="section-title">
                Top Contributors
            </div>
            <table class="leaderboard" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Contributor</th>
                        <th>Total Rewards</th>
                        <th>Contributions</th>
                        <th>Avg PoDL Score</th>
                        <th>Samples</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr>
                        <td colspan="6" class="loading">Loading leaderboard</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Recent Contributions -->
        <div class="section">
            <div class="section-title">
                Recent Contributions
            </div>
            <div id="recentContributions">
                <div class="loading">Loading recent contributions</div>
            </div>
        </div>
        
        <!-- Distribution Chart -->
        <div class="section">
            <div class="section-title">
                Reward Distribution (7 days)
            </div>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const API_BASE = window.API_CONFIG?.baseURL || 'http://165.227.221.225:8000';
        let userAddress = localStorage.getItem('contributorAddress') || '';
        let refreshInterval = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (userAddress) {
                document.getElementById('userAddress').value = userAddress;
                loadUserStats();
            }
            
            loadGlobalStats();
            loadLeaderboard();
            loadRecentContributions();
            loadDistributionChart();
            
            // Auto-refresh every 30 seconds
            refreshInterval = setInterval(refreshData, 30000);
        });
        
        async function loadGlobalStats() {
            try {
                const response = await fetch(`${API_BASE}/rewards/stats`);
                const data = await response.json();
                
                document.getElementById('dailyTotal').textContent = 
                    formatNumber(data.daily.total_distributed) + ' BLY';
                document.getElementById('activeContributors').textContent = 
                    data.daily.distribution_count;
                
                // Load dataset stats
                const datasetResponse = await fetch(`${API_BASE}/datasets/stats`);
                const datasetData = await datasetResponse.json();
                
                document.getElementById('datasetsCount').textContent = 
                    datasetData.total_datasets || 0;
                document.getElementById('avgPodlScore').textContent = 
                    (datasetData.average_podl_score || 0).toFixed(3);
                
            } catch (error) {
                console.error('Failed to load global stats:', error);
            }
        }
        
        async function loadUserStats() {
            const address = document.getElementById('userAddress').value.trim();
            if (!address) return;
            
            userAddress = address;
            localStorage.setItem('contributorAddress', address);
            
            try {
                const response = await fetch(`${API_BASE}/contributors/${address}/stats`);
                const data = await response.json();
                
                const statsHtml = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Earned</div>
                            <div class="stat-value">${formatNumber(data.total_rewards)} BLY</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Contributions</div>
                            <div class="stat-value">${data.total_contributions}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg PoDL Score</div>
                            <div class="stat-value">${data.average_podl_score.toFixed(3)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Samples</div>
                            <div class="stat-value">${formatNumber(data.total_samples)}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('userStatsContent').innerHTML = statsHtml;
                
            } catch (error) {
                console.error('Failed to load user stats:', error);
                document.getElementById('userStatsContent').innerHTML = 
                    '<p style="color: #ef4444;">Failed to load statistics. Please check your address.</p>';
            }
        }
        
        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_BASE}/datasets/leaderboard?limit=10`);
                const data = await response.json();
                
                const tbody = document.getElementById('leaderboardBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af;">No contributions yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(entry => {
                    const rankClass = entry.rank === 1 ? 'gold' : 
                                     entry.rank === 2 ? 'silver' :
                                     entry.rank === 3 ? 'bronze' : '';
                    
                    return `
                        <tr>
                            <td><span class="rank ${rankClass}">#${entry.rank}</span></td>
                            <td><span class="address">${formatAddress(entry.contributor)}</span></td>
                            <td><strong>${formatNumber(entry.total_rewards)} BLY</strong></td>
                            <td>${entry.contributions}</td>
                            <td><span class="score-badge">${entry.average_podl_score}</span></td>
                            <td>${formatNumber(entry.total_samples)}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
        }
        
        async function loadRecentContributions() {
            try {
                const response = await fetch(`${API_BASE}/rewards/recent?limit=10`);
                const data = await response.json();
                
                const container = document.getElementById('recentContributions');
                
                if (data.length === 0) {
                    container.innerHTML = '<p style="color: #9ca3af; text-align: center;">No recent contributions</p>';
                    return;
                }
                
                container.innerHTML = data.map(contrib => {
                    const typeClass = `type-${contrib.distribution_type}`;
                    const timeAgo = getTimeAgo(new Date(contrib.distributed_at));
                    
                    return `
                        <div class="contribution-item">
                            <div class="contribution-info">
                                <span class="contribution-type ${typeClass}">${contrib.distribution_type}</span>
                                <div class="contribution-description">${contrib.reason}</div>
                                <div class="contribution-time">${timeAgo}</div>
                            </div>
                            <div class="contribution-reward">
                                <div class="reward-amount">+${formatNumber(contrib.amount)}</div>
                                <div class="reward-label">BLY Reward</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load recent contributions:', error);
            }
        }
        
        async function loadDistributionChart() {
            try {
                const response = await fetch(`${API_BASE}/rewards/history?days=7`);
                const data = await response.json();
                
                const ctx = document.getElementById('distributionChart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: 'Dataset Rewards',
                                data: data.dataset_rewards,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Inference Rewards',
                                data: data.inference_rewards,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Learning Rewards',
                                data: data.learning_rewards,
                                borderColor: '#ec4899',
                                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e0e0e0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#9ca3af',
                                    callback: function(value) {
                                        return value + ' BLY';
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Failed to load distribution chart:', error);
            }
        }
        
        function refreshData() {
            loadGlobalStats();
            loadLeaderboard();
            loadRecentContributions();
            if (userAddress) {
                loadUserStats();
            }
        }
        
        function formatNumber(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(2);
        }
        
        function formatAddress(address) {
            if (address.length <= 20) return address;
            return address.slice(0, 6) + '...' + address.slice(-4);
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }
    </script>
</body>
</html>