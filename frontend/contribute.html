<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join the Network - Blyan</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="shortcut icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="common-header-themed.css">
    <link rel="stylesheet" href="page-template.css">
    <script src="language.js"></script>
    <script src="wallet.js"></script>
    <script src="theme.js?v=2"></script>
    <style>
        /* Theme variables */
        :root {
            --color-primary: #1E3A8A;
            --color-primary-light: #2E4EAE;
            --color-primary-dark: #152C66;
            --color-secondary: #06B6D4;
            --color-secondary-light: #22D3EE;
            --color-secondary-dark: #0891B2;
            --color-background: #FFFFFF;
            --color-surface: #F9FAFB;
            --color-elevated: #FFFFFF;
            --color-text-primary: #111827;
            --color-text-secondary: #374151;
            --color-text-disabled: #9CA3AF;
            --color-divider: #E5E7EB;
            --color-action-hover: rgba(30, 58, 138, 0.08);
            --color-action-selected: rgba(30, 58, 138, 0.12);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.03);
            --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.12);
        }
        
        [data-theme="dark"] {
            --color-primary: #22D3EE;
            --color-primary-light: #67E8F9;
            --color-primary-dark: #06B6D4;
            --color-secondary: #2E4EAE;
            --color-secondary-light: #4361C2;
            --color-secondary-dark: #1E3A8A;
            --color-background: #111827;
            --color-surface: #1F2937;
            --color-elevated: #0F172A;
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #D1D5DB;
            --color-text-disabled: #4B5563;
            --color-divider: #374151;
            --color-action-hover: rgba(6, 182, 212, 0.12);
            --color-action-selected: rgba(6, 182, 212, 0.16);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.5);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--color-text-primary);
            background-color: var(--color-background);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
        }

        /* Requirements Grid */
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(145deg, var(--color-surface), var(--color-elevated));
            border-radius: 12px;
            border: 1px solid var(--color-divider);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .requirement-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            border-radius: 12px 12px 0 0;
        }
        
        .requirement-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .requirement-icon {
            font-size: 24px;
        }

        .requirement-text {
            flex: 1;
        }

        .requirement-label {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .requirement-value {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        /* Setup Steps */
        .setup-steps {
            counter-reset: step-counter;
            margin-top: 40px;
        }

        .setup-step {
            position: relative;
            padding: 24px;
            padding-left: 60px;
            margin-bottom: 24px;
            background: linear-gradient(145deg, var(--color-surface), var(--color-elevated));
            border-radius: 12px;
            border: 1px solid var(--color-divider);
            transition: all 0.3s ease;
        }
        
        .setup-step::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--color-primary), var(--color-secondary));
            border-radius: 12px 0 0 12px;
        }

        .setup-step:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .setup-step::before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-background);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            z-index: 1;
        }

        .step-title {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 8px;
        }

        .step-description {
            color: var(--color-text-secondary);
        }

        /* Code block */
        .code-block {
            background: var(--color-elevated);
            border: 1px solid var(--color-divider);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            color: var(--color-text-primary);
        }

        /* Modal styles for node key generation */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--color-elevated);
            color: var(--color-text-primary);
            width: min(720px, 90%);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0;
        }
        
        .modal-close {
            border: none;
            background: transparent;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 4px;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: var(--color-text-primary);
        }
        
        .modal-body {
            color: var(--color-text-secondary);
        }
        
        .modal-button {
            background: var(--color-primary);
            color: var(--color-background);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }
        
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: var(--color-background);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 0px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-divider);
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            color: var(--color-primary);
        }

        .collapsible-header .section-title {
            margin: 0;
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }

        .collapse-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            color: var(--color-text-secondary);
        }

        .collapsible-header:hover .collapse-icon {
            color: var(--color-primary);
        }

        .collapse-icon.rotated {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding-top: 20px;
            animation: slideDown 0.3s ease-out;
        }
        
        /* Join code states */
        .is-expired {
            opacity: 0.5;
            text-decoration: line-through;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <!-- Requirements Section -->
    <div class="feature-section" style="padding-top: 40px;">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title" data-i18n="systemRequirements">System Requirements</h2>
                <p class="section-subtitle" data-i18n="systemRequirementsDesc">What you need to join the network</p>
            </div>
            <div class="requirements-grid">
                <div class="requirement-item">
                    <span class="requirement-icon">üñ•Ô∏è</span>
                    <div class="requirement-text">
                        <div class="requirement-label" data-i18n="gpu">GPU</div>
                        <div class="requirement-value">NVIDIA RTX 3060 or better</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">üíæ</span>
                    <div class="requirement-text">
                        <div class="requirement-label" data-i18n="vram">VRAM</div>
                        <div class="requirement-value">12GB minimum, 24GB+ recommended</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">üåê</span>
                    <div class="requirement-text">
                        <div class="requirement-label" data-i18n="internet">Internet</div>
                        <div class="requirement-value">100 Mbps+ stable connection</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">üê≥</span>
                    <div class="requirement-text">
                        <div class="requirement-label" data-i18n="software">Software</div>
                        <div class="requirement-value">Docker & NVIDIA drivers</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Setup Guide Section (Docker) -->
    <div class="feature-section alt-background">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">üöÄ Quick Setup with Docker (Recommended)</h2>
                <p class="section-subtitle">Join the network in 5 simple steps using Docker</p>
            </div>
            
            <!-- Quick link to Common Concepts -->
            <div style="text-align: center; margin-bottom: 20px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <p style="margin: 0; color: var(--color-text-secondary);">
                    üëâ Need more details? See <a href="#common-concepts" style="color: var(--color-primary); text-decoration: none; font-weight: 600;">üìö Common Concepts</a> for API endpoints, security notes, and credential management
                </p>
            </div>
            <div class="setup-steps">
                <div class="setup-step">
                    <div class="step-title">Step 1: Get Your JOIN_CODE</div>
                    <div class="step-description">Request a one-time enrollment code</div>
                    <div style="padding: 16px; background: rgba(59, 130, 246, 0.03); border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 12px;">
                        <button onclick="requestJoinCode()" style="
                            background: var(--color-primary);
                            color: var(--color-background);
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            margin-bottom: 12px;
                        " id="joinCodeBtn">
                            Request Join Code
                        </button>
                        <div id="joinCodeResult" style="display: none; margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.03); border-radius: 6px;">
                            <strong>Your Join Code:</strong> <code id="joinCodeDisplay" style="font-size: 1.2em; font-weight: bold;"></code><br>
                            <small style="color: var(--color-text-secondary);">Valid for 30 minutes. Use it in Step 4 below.</small>
                        </div>
                        <p style="margin-top: 12px; font-size: 0.9rem; color: var(--color-text-secondary);">
                            <em>See Common Concepts below for details on JOIN_CODE and credentials.</em>
                        </p>
                    </div>
                </div>
                <div class="setup-step">
                    <div class="step-title">Step 2: Pull the Docker Image</div>
                    <div class="step-description">Download the official Blyan node image</div>
                    <div class="code-block">
                        docker pull mnls0115/blyan-node:latest
                    </div>
                </div>
                <div class="setup-step">
                    <div class="step-title">Step 3: Prepare Your Environment</div>
                    <div class="step-description">Set up persistent storage and networking with security hardening</div>
                    <div class="code-block">
                        # Create data directory for credentials<br>
                        sudo mkdir -p /var/lib/blyan/data<br>
                        sudo chmod 755 /var/lib/blyan<br>
                        sudo chown $USER:$USER /var/lib/blyan/data<br><br>
                        
                        # Configure firewall (UFW)<br>
                        sudo ufw allow 8001/tcp comment 'Blyan Node'<br>
                        sudo ufw limit ssh comment 'Rate limit SSH'<br>
                        sudo ufw --force enable<br><br>
                        
                        # Optional: Set up fail2ban for additional protection<br>
                        sudo apt-get install -y fail2ban
                    </div>
                    <p style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.03); border-radius: 6px;">
                        üí° <strong>Security Tip:</strong> Consider using a dedicated user account for running the node instead of root.
                    </p>
                </div>
                <div class="setup-step">
                    <div class="step-title">Step 4: Run Your Node</div>
                    <div class="step-description">Start the node with your JOIN_CODE from Step 1</div>
                    <div class="code-block">
                        docker run -d --name blyan-node \<br>
                        &nbsp;&nbsp;--gpus all \<br>
                        &nbsp;&nbsp;-p 8001:8001 \<br>
                        &nbsp;&nbsp;-v /var/lib/blyan/data:/data \<br>
                        &nbsp;&nbsp;-e JOIN_CODE=<span style="color: #ef4444;">YOUR_CODE_HERE</span> \<br>
                        &nbsp;&nbsp;-e PUBLIC_IP=$(curl -s https://checkip.amazonaws.com) \<br>
                        &nbsp;&nbsp;--restart unless-stopped \<br>
                        &nbsp;&nbsp;mnls0115/blyan-node:latest
                    </div>
                    <p style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.03); border-radius: 6px; color: var(--color-text-secondary);">
                        üí° <strong>GPU Note:</strong> Omit <code>--gpus all</code> if you don't have NVIDIA GPU/drivers.
                    </p>
                </div>
                <div class="setup-step">
                    <div class="step-title">Step 5: Verify Enrollment & Security Status</div>
                    <div class="step-description">Confirm successful network registration and security configuration</div>
                    <div class="code-block">
                        # Check enrollment status<br>
                        docker logs blyan-node | grep -E "enrollment|credentials"<br><br>
                        
                        # Verify credential permissions<br>
                        docker exec blyan-node ls -la /data/credentials.json<br>
                        # Should show: -rw------- (600)<br><br>
                        
                        # Test health endpoint<br>
                        curl http://localhost:8001/<br><br>
                        
                        # Check security headers<br>
                        curl -I http://localhost:8001/
                    </div>
                    <div class="code-block" style="margin-top: 12px; background: rgba(34, 197, 94, 0.03); border-left: 4px solid #22c55e;">
                        ‚úì JOIN_CODE validated successfully<br>
                        ‚úì Node credentials obtained (node_id: gpu-xxxx)<br>
                        ‚úì Credentials saved with correct permissions (600)<br>
                        ‚úì Security headers configured<br>
                        ‚úì Ready for inference requests
                    </div>
                    <p style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.03); border-radius: 6px;">
                        ‚ö†Ô∏è <strong>Security Check:</strong> If credentials show wrong permissions, run: <code>docker exec blyan-node chmod 600 /data/credentials.json</code>
                    </p>
                </div>
                <div class="setup-step">
                    <div class="step-title">Step 6: Restarting Your Node</div>
                    <div class="step-description">How to stop, start, and restart your node</div>
                    <div style="padding: 16px; background: rgba(34, 197, 94, 0.03); border-radius: 8px; margin-top: 12px;">
                        <p style="margin: 0 0 12px 0; color: var(--color-text-primary); font-weight: 600;">
                            ‚ú® No JOIN_CODE needed for restarts!
                        </p>
                        <p style="margin: 0 0 12px 0; color: var(--color-text-secondary);">
                            After the first enrollment, your node has permanent credentials stored in <code>/data/credentials.json</code>. 
                            These are automatically loaded on every restart.
                        </p>
                    </div>
                    <div class="code-block" style="margin-top: 12px;">
                        # Simple restart<br>
                        docker restart blyan-node<br><br>
                        
                        # Or manual stop/start<br>
                        docker stop blyan-node<br>
                        docker start blyan-node<br><br>
                        
                        # View logs after restart<br>
                        docker logs -f blyan-node
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.03); border-radius: 6px;">
                        <p style="margin: 0 0 8px 0;"><strong>‚ö†Ô∏è When you need a new JOIN_CODE:</strong></p>
                        <p style="margin: 0 0 4px 0;">‚Ä¢ If you delete <code>/var/lib/blyan/data</code> directory</p>
                        <p style="margin: 0 0 4px 0;">‚Ä¢ If you move to a new machine without copying credentials</p>
                        <p style="margin: 0;">‚Ä¢ If credentials expire (after 90 days)</p>
                    </div>
                </div>
            </div>
            <div style="margin-top: 30px; padding: 20px; background: rgba(34, 197, 94, 0.03); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                <p style="margin: 0; color: var(--color-text-primary); font-weight: 600;">
                    ‚úÖ That's it! Your node is now part of the Blyan network.
                </p>
            </div>
        </div>
    </div>

    <!-- Common Concepts Section -->
    <div class="feature-section" id="common-concepts">
        <div class="section-container">
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('common-concepts-content')">
                    <div>
                        <h2 class="section-title">üìö Common Concepts</h2>
                        <p class="section-subtitle">Essential information for all installation methods</p>
                    </div>
                    <span class="collapse-icon" id="common-concepts-content-icon">‚ñº</span>
                </div>
                <div class="collapsible-content" id="common-concepts-content" style="display: none;">
                    <div class="setup-steps">
                <!-- JOIN_CODE Flow -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('joincode-flow')">
                        <div class="step-title">üîë JOIN_CODE ‚Üí Permanent Credentials Flow</div>
                        <span class="collapse-icon" id="joincode-flow-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="joincode-flow" style="display: none;">
                        <div class="step-description">How nodes authenticate with the network</div>
                        <div style="padding: 16px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; margin-top: 12px;">
                            <p style="margin: 0 0 12px 0;"><strong>1. Request JOIN_CODE:</strong> Get a one-time code from this page (valid for 30 minutes)</p>
                            <p style="margin: 0 0 12px 0;"><strong>2. First Boot:</strong> Node exchanges JOIN_CODE for permanent credentials</p>
                            <p style="margin: 0 0 12px 0;"><strong>3. Credentials Stored:</strong> Node saves credentials to <code>/data/credentials.json</code></p>
                            <p style="margin: 0;"><strong>4. Future Restarts:</strong> Node uses stored credentials automatically (no JOIN_CODE needed)</p>
                        </div>
                    </div>
                </div>
                
                <!-- Credential Storage -->
                <div class="collapsible-section" style="margin-top: 20px;">
                    <div class="collapsible-header" onclick="toggleSection('credential-storage')">
                        <div class="step-title">üìÇ Credential Storage & Management</div>
                        <span class="collapse-icon" id="credential-storage-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="credential-storage" style="display: none;">
                        <div class="step-description">Where your node keeps its authentication</div>
                    <div class="code-block">
                        # Docker: Mounted volume<br>
                        /var/lib/blyan/data ‚Üí /data/credentials.json<br><br>
                        
                        # Binary/Source: Local directory<br>
                        ./data/credentials.json<br><br>
                        
                        # Contents (auto-generated):<br>
                        {<br>
                        &nbsp;&nbsp;"node_id": "gpu-xxxx-yyyy",<br>
                        &nbsp;&nbsp;"node_key": "secret_key_here",<br>
                        &nbsp;&nbsp;"expires_at": "2024-04-01T00:00:00Z"<br>
                        }
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: rgba(220, 38, 38, 0.03); border-radius: 6px; border: 1px solid rgba(220, 38, 38, 0.3);">
                        <p style="margin: 0 0 8px 0;"><strong>‚ö†Ô∏è Critical Security Requirements:</strong></p>
                        <p style="margin: 0 0 4px 0; font-size: 0.9rem;">‚Ä¢ <strong>File Permissions:</strong> Must be <code>chmod 600</code> (owner read/write only)</p>
                        <p style="margin: 0 0 4px 0; font-size: 0.9rem;">‚Ä¢ <strong>Credential Renewal:</strong> Expires after 90 days - monitor expiry date</p>
                        <p style="margin: 0 0 4px 0; font-size: 0.9rem;">‚Ä¢ <strong>Backup Security:</strong> Encrypt backups and store offline</p>
                        <p style="margin: 0; font-size: 0.9rem;">‚Ä¢ <strong>Never:</strong> Commit to git, share publicly, or transmit unencrypted</p>
                    </div>
                        <p style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.03); border-radius: 6px;">
                            üí° <strong>Tip:</strong> Set up monitoring to alert you 7 days before credential expiry.
                        </p>
                    </div>
                </div>
                
                <!-- API Endpoints -->
                <div class="collapsible-section" style="margin-top: 20px;">
                    <div class="collapsible-header" onclick="toggleSection('api-endpoints')">
                        <div class="step-title">üåê API Endpoints & Ports</div>
                        <span class="collapse-icon" id="api-endpoints-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="api-endpoints" style="display: none;">
                        <div class="step-description">Network communication details</div>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                        <tr style="border-bottom: 1px solid var(--color-divider);">
                            <td style="padding: 8px;"><strong>Main Server:</strong></td>
                            <td style="padding: 8px;"><code>https://blyan.com/api</code></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-divider);">
                            <td style="padding: 8px;"><strong>Node API Port:</strong></td>
                            <td style="padding: 8px;"><code>8001</code> (your node's service)</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-divider);">
                            <td style="padding: 8px;"><strong>Health Check:</strong></td>
                            <td style="padding: 8px;"><code>GET http://localhost:8001/</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><strong>Enrollment:</strong></td>
                            <td style="padding: 8px;"><code>POST /p2p/enroll</code> (automatic)</td>
                        </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Security Notes -->
                <div class="collapsible-section" style="margin-top: 20px;">
                    <div class="collapsible-header" onclick="toggleSection('security-practices')">
                        <div class="step-title">üîí Security Best Practices</div>
                        <span class="collapse-icon" id="security-practices-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="security-practices" style="display: none;">
                        <div class="step-description">Essential security measures for production deployment</div>
                    
                    <!-- Authentication Security -->
                    <div style="padding: 16px; background: rgba(220, 38, 38, 0.03); border-radius: 8px; margin-top: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--color-text-primary);">üîê Authentication & Credentials</h4>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>JOIN_CODE:</strong> Single-use, 30-minute expiry, rate-limited generation</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Node Credentials:</strong> 90-day validity with JWT-based authentication</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>File Permissions:</strong> Always <code>chmod 600 /data/credentials.json</code></p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Key Rotation:</strong> Monitor expiry and renew before expiration</p>
                        <p style="margin: 0;">‚Ä¢ <strong>Secret Management:</strong> Use environment variables, never hardcode</p>
                    </div>
                    
                    <!-- Network Security -->
                    <div style="padding: 16px; background: rgba(59, 130, 246, 0.03); border-radius: 8px; margin-top: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--color-text-primary);">üåê Network & API Security</h4>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>TLS/SSL:</strong> All API communications use HTTPS encryption</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Firewall Rules:</strong> Only open port 8001 for node service</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>IP Whitelisting:</strong> Consider restricting main server access</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>DDoS Protection:</strong> Implement rate limiting at network level</p>
                        <p style="margin: 0;">‚Ä¢ <strong>VPN Option:</strong> Use VPN for additional network isolation</p>
                    </div>
                    
                    <!-- Container Security -->
                    <div style="padding: 16px; background: rgba(34, 197, 94, 0.03); border-radius: 8px; margin-top: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--color-text-primary);">üê≥ Container & Runtime Security</h4>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Non-Root User:</strong> Container runs as non-privileged user</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Read-Only Filesystem:</strong> Only /data is writable</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Resource Limits:</strong> Set CPU/memory limits to prevent abuse</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Security Scanning:</strong> Regular vulnerability scans on images</p>
                        <p style="margin: 0;">‚Ä¢ <strong>Update Policy:</strong> Pull latest images weekly for patches</p>
                    </div>
                    
                    <!-- Logging & Monitoring -->
                    <div style="padding: 16px; background: rgba(245, 158, 11, 0.03); border-radius: 8px; margin-top: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--color-text-primary);">üìä Logging & Monitoring</h4>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Log Security:</strong> Logs never contain keys or sensitive data</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Audit Trail:</strong> All enrollment/authentication attempts logged</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Health Monitoring:</strong> Regular health checks on /health endpoint</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Anomaly Detection:</strong> Monitor for unusual request patterns</p>
                        <p style="margin: 0;">‚Ä¢ <strong>Log Retention:</strong> Keep logs for 30 days for security analysis</p>
                    </div>
                    
                    <!-- Incident Response -->
                    <div style="padding: 16px; background: rgba(220, 38, 38, 0.03); border-radius: 8px; margin-top: 12px; border: 2px solid rgba(220, 38, 38, 0.3);">
                        <h4 style="margin: 0 0 12px 0; color: #dc2626; display: flex; align-items: center; gap: 8px;">
                            <span style="background: #dc2626; color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.75rem; font-weight: 600;">CRITICAL</span>
                            üö® Incident Response Plan
                        </h4>
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #dc2626;">‚Ä¢ <strong>Compromised Key:</strong> Immediately request new JOIN_CODE and re-enroll</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Suspicious Activity:</strong> Contact <a href="mailto:mnls0115@naver.com" style="color: #dc2626; font-weight: 600;">mnls0115@naver.com</a></p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Node Quarantine:</strong> Automatic isolation of suspicious nodes</p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ <strong>Recovery Process:</strong> Documented steps for credential rotation</p>
                        <p style="margin: 0;">‚Ä¢ <strong>Security Updates:</strong> Subscribe to security announcements</p>
                        </div>
                    </div>
                </div>
                
                <!-- Restart Behavior -->
                <div class="collapsible-section" style="margin-top: 20px;">
                    <div class="collapsible-header" onclick="toggleSection('restart-recovery')">
                        <div class="step-title">‚ôªÔ∏è Restart & Recovery</div>
                        <span class="collapse-icon" id="restart-recovery-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="restart-recovery" style="display: none;">
                        <div class="step-description">What happens when you restart</div>
                    <div style="padding: 16px; background: rgba(34, 197, 94, 0.03); border-radius: 8px; margin-top: 12px;">
                        <p style="margin: 0 0 12px 0;"><strong>‚úÖ Normal Restart:</strong> Node uses existing credentials from <code>/data/credentials.json</code></p>
                        <p style="margin: 0 0 12px 0;"><strong>‚úÖ No JOIN_CODE Needed:</strong> After first enrollment, restarts work automatically</p>
                        <p style="margin: 0 0 12px 0;"><strong>‚ö†Ô∏è New Machine:</strong> Copy credentials or request new JOIN_CODE</p>
                            <p style="margin: 0;"><strong>‚ùå Lost Data:</strong> If <code>/data</code> deleted, request new JOIN_CODE</p>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Installation Section (Collapsible) -->
    <div class="feature-section" style="padding-top: 40px;">
        <div class="section-container">
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('advanced-install')">
                    <h2 class="section-title">‚öôÔ∏è Advanced Installation (Optional)</h2>
                    <span class="collapse-icon" id="advanced-install-icon">‚ñº</span>
                </div>
                <div class="collapsible-content" id="advanced-install" style="display: none;">
                    <p class="section-subtitle" style="margin-bottom: 15px;">Alternative installation methods for binary and source deployments</p>
                    
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(245, 158, 11, 0.03); border-radius: 8px; border: 2px solid #f59e0b;">
                        <h4 style="margin-top: 0; color: #f59e0b;">üì¶ Binary/Source Requirements</h4>
                        <p style="margin-bottom: 8px; color: var(--color-text-primary);">
                            <strong>For non-Docker deployments, you need a direct API key:</strong>
                        </p>
                        <p style="margin: 0; color: var(--color-text-secondary);">
                            ‚Ä¢ Email <a href="mailto:mnls0115@naver.com" style="color: var(--color-primary);">mnls0115@naver.com</a> with your GPU specs<br>
                            ‚Ä¢ Receive your API key (valid for 90 days)<br>
                            ‚Ä¢ Configure as environment variable: <code>export BLYAN_API_KEY=your_key</code>
                        </p>
                        <p style="margin-top: 8px; font-size: 0.9rem; color: var(--color-text-secondary);">
                            <em>See Common Concepts above for API endpoints and security notes.</em>
                        </p>
                    </div>

                    <div class="setup-steps" style="margin-top: 20px;">
                        <div class="setup-step">
                            <div class="step-title">Option A: Signed Binaries</div>
                            <div class="step-description">
                                Pre-compiled binaries with GPG signatures
                            </div>
                            <div class="code-block">
                                # 1. Get your API key (see above)<br>
                                export BLYAN_API_KEY=your_api_key_here<br>
                                export MAIN_SERVER_URL=https://blyan.com/api<br><br>
                                
                                # 2. Download and verify binary<br>
                                wget https://releases.blyan.com/latest/blyan-node-linux-amd64<br>
                                wget https://releases.blyan.com/latest/blyan-node-linux-amd64.sig<br>
                                gpg --verify blyan-node-linux-amd64.sig blyan-node-linux-amd64<br><br>
                                
                                # 3. Run the node<br>
                                chmod +x blyan-node-linux-amd64<br>
                                ./blyan-node-linux-amd64
                            </div>
                            <p style="margin-top: 12px; padding: 8px; background: rgba(220, 38, 38, 0.03); border-radius: 4px;">
                                üîí Always verify GPG signatures before running binaries
                            </p>
                        </div>
                        
                        <div class="setup-step">
                            <div class="step-title">Option B: From Source</div>
                            <div class="step-description">
                                Clone repository and run with Python
                            </div>
                            <div class="code-block">
                                # 1. Clone the repository<br>
                                git clone https://github.com/mnls0115/Blyan.git<br>
                                cd Blyan<br><br>
                                
                                # 2. Set up environment<br>
                                python3 -m venv venv<br>
                                source venv/bin/activate<br>
                                pip install -r requirements.txt<br><br>
                                
                                # 3. Configure credentials<br>
                                export BLYAN_API_KEY=your_api_key_here<br>
                                export MAIN_SERVER_URL=https://blyan.com/api<br>
                                export PUBLIC_IP=$(curl -s https://checkip.amazonaws.com)<br><br>
                                
                                # 4. Run the node<br>
                                python run_blyan_node.py
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Developer Mode Section (Collapsible) -->
    <div class="feature-section" style="padding-top: 40px;">
        <div class="section-container">
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('developer-mode')">
                    <h2 class="section-title">üõ†Ô∏è Developer Mode (For Contributors)</h2>
                    <span class="collapse-icon" id="developer-mode-icon">‚ñº</span>
                </div>
                <div class="collapsible-content" id="developer-mode" style="display: none;">
                    <p class="section-subtitle" style="margin-bottom: 15px;">Run from source code for development and testing</p>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background: rgba(245, 158, 11, 0.03); border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: var(--color-text-primary);">
                            ‚ö†Ô∏è <strong>For developers only:</strong> Runs from source code, may be unstable. Not recommended for production use.
                        </p>
                    </div>

                    <div class="setup-steps" style="margin-top: 20px;">
                        <div class="setup-step">
                            <div class="step-title">Development Setup</div>
                            <div class="step-description">
                                Set up a local development environment
                            </div>
                            <div class="code-block">
                                # Clone the repository<br>
                                git clone https://github.com/mnls0115/Blyan.git<br>
                                cd Blyan<br><br>
                                
                                # Create virtual environment<br>
                                python3 -m venv venv<br>
                                source venv/bin/activate<br><br>
                                
                                # Install dependencies<br>
                                pip install -r requirements.txt<br><br>
                                
                                # Run in development mode<br>
                                export NODE_ENV=development<br>
                                python run_gpu_node.py
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rewards Section -->
    <div class="stats-section">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title" data-i18n="earningPotential">Earning Potential</h2>
                <p class="section-subtitle" data-i18n="earningPotentialDesc">Estimated rewards based on GPU type</p>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">~45 BLY</div>
                    <div class="stat-label">RTX 3060 12GB / day</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">~80 BLY</div>
                    <div class="stat-label">RTX 3080 / day</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">~120 BLY</div>
                    <div class="stat-label">RTX 4070 Ti / day</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">~200 BLY</div>
                    <div class="stat-label">RTX 4090 / day</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Section -->
    <div class="feature-section" style="padding: 40px 0; background: rgba(59, 130, 246, 0.05);">
        <div class="section-container">
            <div style="text-align: center; padding: 20px;">
                <h3 style="margin-bottom: 10px; color: var(--color-text-primary);">Need Help?</h3>
                <p style="margin: 0; color: var(--color-text-secondary);">
                    If you have any questions about setting up your node or need technical support, 
                    feel free to reach out at <a href="mailto:mnls0115@naver.com" style="color: var(--color-primary); text-decoration: none; font-weight: 600;">mnls0115@naver.com</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Join modal -->
    <div id="joinModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="joinTheNetwork">Join the Network</h3>
                <button id="joinClose" class="modal-close" aria-label="Close modal">‚úñ</button>
            </div>
            <div id="joinBody" class="modal-body">
                <p data-i18n="joinModalDesc">Quick reference for Docker setup:</p>
                
                <h4 style="margin-top: 20px; color: var(--color-primary);">üöÄ Docker Quick Start</h4>
                
                <div class="code-block">
                    # 1. Get JOIN_CODE from this page (Request Join Code button)<br><br>
                    
                    # 2. Pull image<br>
                    docker pull mnls0115/blyan-node:latest<br><br>
                    
                    # 3. Create data directory<br>
                    sudo mkdir -p /var/lib/blyan/data<br><br>
                    
                    # 4. Run with JOIN_CODE (first time only)<br>
                    docker run -d --name blyan-node \<br>
                    &nbsp;&nbsp;--gpus all \<br>
                    &nbsp;&nbsp;-p 8001:8001 \<br>
                    &nbsp;&nbsp;-v /var/lib/blyan/data:/data \<br>
                    &nbsp;&nbsp;-e JOIN_CODE=YOUR_CODE_HERE \<br>
                    &nbsp;&nbsp;--restart unless-stopped \<br>
                    &nbsp;&nbsp;mnls0115/blyan-node:latest<br><br>
                    
                    # 5. Verify<br>
                    docker logs blyan-node
                </div>
                
                <p style="margin-top:20px; padding: 16px; background: rgba(34, 197, 94, 0.03); border-radius: 8px; color: var(--color-text-primary);">
                    ‚úÖ <strong>Remember:</strong> JOIN_CODE is only needed for first enrollment. Future restarts use stored credentials automatically.
                </p>
                
                <p style="margin-top:16px; text-align: center; color: var(--color-text-secondary);">
                    See <strong>Common Concepts</strong> and full guide below for details.
                </p>
            </div>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <span id="themeIcon">üåô</span>
    </button>

    <script src="config.js?v=2"></script>
    <script src="api-auth.js?v=2"></script>
    <script src="common-header.js?v=4"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Create header
            document.getElementById('header-container').innerHTML = createAIBlockHeader('contribute');
            
            // Theme toggle functionality
            document.getElementById('themeToggle').addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            // Wire Join button
            document.getElementById('joinClose').addEventListener('click', () => {
                document.getElementById('joinModal').style.display = 'none';
            });
        });
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        function openJoinModal() {
            document.getElementById('joinModal').style.display = 'flex';
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.classList.add('rotated');
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.classList.remove('rotated');
                icon.textContent = '‚ñº';
            }
        }
        
        function selectDeploymentMethod(method) {
            const dockerBtn = document.getElementById('dockerMethodBtn');
            const binaryBtn = document.getElementById('binaryMethodBtn');
            const dockerDiv = document.getElementById('dockerMethod');
            const binaryDiv = document.getElementById('binaryMethod');
            
            if (method === 'docker') {
                // Show Docker method
                dockerBtn.style.background = 'var(--color-primary)';
                dockerBtn.style.color = 'var(--color-background)';
                dockerBtn.style.borderColor = 'var(--color-primary)';
                
                binaryBtn.style.background = 'transparent';
                binaryBtn.style.color = 'var(--color-text-primary)';
                binaryBtn.style.borderColor = 'var(--color-divider)';
                
                dockerDiv.style.display = 'block';
                binaryDiv.style.display = 'none';
                
                // Store preference
                localStorage.setItem('blyan_deployment_method', 'docker');
                
            } else {
                // Show Binary/Source method
                binaryBtn.style.background = 'var(--color-primary)';
                binaryBtn.style.color = 'var(--color-background)';
                binaryBtn.style.borderColor = 'var(--color-primary)';
                
                dockerBtn.style.background = 'transparent';
                dockerBtn.style.color = 'var(--color-text-primary)';
                dockerBtn.style.borderColor = 'var(--color-divider)';
                
                dockerDiv.style.display = 'none';
                binaryDiv.style.display = 'block';
                
                // Store preference
                localStorage.setItem('blyan_deployment_method', 'binary');
            }
        }
        
        async function requestJoinCode() {
            const btn = document.getElementById('joinCodeBtn');
            const resultDiv = document.getElementById('joinCodeResult');
            const codeDisplay = document.getElementById('joinCodeDisplay');
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.textContent = 'Requesting...';
            
            try {
                // Request join code from server
                const response = await fetch(`${API_CONFIG?.baseURL || '/api'}/p2p/join-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        node_type: 'gpu',
                        // Add simple client-side rate limiting
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Display the join code
                    codeDisplay.textContent = data.join_code || '‚Äì';
                    codeDisplay.classList.remove('is-expired');
                    resultDiv.style.display = 'block';
                    
                    // Hide the request button since code is single-use
                    btn.style.display = 'none';
                    
                    // Store in session for convenience (not for security)
                    sessionStorage.setItem('blyan_join_code', data.join_code);
                    sessionStorage.setItem('blyan_join_code_expires', data.expires_at);
                    
                    // Show expiry countdown with new system
                    const exp = parseExpiry(data.expires_at);
                    renderCountdown(exp);
                    
                } else if (response.status === 429) {
                    // Rate limited
                    alert('Too many requests. Please wait a few minutes and try again.');
                    btn.textContent = 'Request Join Code';
                    btn.disabled = false;
                } else {
                    // Other error
                    const error = await response.text();
                    alert(`Failed to get join code: ${error}`);
                    btn.textContent = 'Request Join Code';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error requesting join code:', error);
                alert('Network error. Please check your connection and try again.');
                btn.textContent = 'Request Join Code';
                btn.disabled = false;
            }
        }
        
        // Utility function for timestamp parsing
        function parseExpiry(ts) {
            if (!ts) return Date.now() + 30 * 60 * 1000;
            if (typeof ts === 'number') {
                const result = ts < 1e12 ? ts * 1000 : ts;
                return result;
            }
            
            // Handle timestamps without timezone (assume local time)
            if (typeof ts === 'string' && !ts.includes('+') && !ts.includes('Z')) {
                // If no timezone indicator, treat as local time by appending current offset
                const localDate = new Date(ts);
                if (!isNaN(localDate.getTime())) {
                    return localDate.getTime();
                }
            }
            
            const t = Date.parse(ts);
            // If parsing fails, default to 30 minutes from now
            if (isNaN(t)) {
                return Date.now() + 30 * 60 * 1000;
            }
            return t;
        }
        
        // Global countdown interval to clear previous ones
        let countdownInterval = null;
        
        function renderCountdown(expMs) {
            const statusEl = document.getElementById('joinCodeResult');
            const badgeEl = document.getElementById('joinCodeDisplay');
            
            // Clear previous interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Remove existing expiry messages
            const existingExpiry = statusEl.querySelector('.expiry-message');
            if (existingExpiry) {
                existingExpiry.remove();
            }
            
            const tick = () => {
                const now = Date.now();
                const left = expMs - now;
                
                // Add 10 second buffer to prevent false expiration due to clock drift
                if (left <= -10000) {
                    // Show expired message
                    const expiryMsg = document.createElement('div');
                    expiryMsg.className = 'expiry-message';
                    expiryMsg.style.color = '#ef4444';
                    expiryMsg.style.marginTop = '12px';
                    expiryMsg.innerHTML = '‚ö†Ô∏è This code has expired. Please request a new one.';
                    statusEl.appendChild(expiryMsg);
                    
                    if (badgeEl) badgeEl.classList.add('is-expired');
                    
                    // Show request button again
                    const btn = document.getElementById('joinCodeBtn');
                    if (btn) {
                        btn.style.display = 'inline-block';
                        btn.textContent = 'Request New Code';
                        btn.disabled = false;
                    }
                    
                    clearInterval(countdownInterval);
                    return;
                }
                
                // Handle negative time gracefully
                const timeLeft = Math.max(0, left);
                const m = Math.floor(timeLeft / 60000);
                const s = Math.floor((timeLeft % 60000) / 1000);
                
                // Update timer in the small element
                let timerSpan = document.getElementById('joinCodeTimer');
                if (!timerSpan) {
                    timerSpan = document.createElement('span');
                    timerSpan.id = 'joinCodeTimer';
                    timerSpan.style.marginLeft = '10px';
                    timerSpan.style.color = 'var(--color-text-secondary)';
                    timerSpan.setAttribute('aria-live', 'polite');
                    const smallElement = statusEl.querySelector('small');
                    if (smallElement) {
                        smallElement.appendChild(timerSpan);
                    }
                }
                
                if (timerSpan) {
                    timerSpan.textContent = ` (${m}m ${s}s remaining)`;
                }
            };
            
            countdownInterval = setInterval(tick, 1000);
            tick(); // Run immediately
        }
        
        function startExpiryCountdown(expiresAt) {
            const exp = parseExpiry(expiresAt);
            renderCountdown(exp);
        }
        
        // Check if there's an existing join code in session on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedCode = sessionStorage.getItem('blyan_join_code');
            const savedExpiry = sessionStorage.getItem('blyan_join_code_expires');
            
            if (savedCode && savedExpiry) {
                const expiryTime = parseExpiry(savedExpiry);
                const now = Date.now();
                
                // Add 10 second grace period for page reload
                if (expiryTime > (now - 10000)) {
                    // Code is still valid, display it
                    document.getElementById('joinCodeDisplay').textContent = savedCode;
                    document.getElementById('joinCodeResult').style.display = 'block';
                    document.getElementById('joinCodeBtn').style.display = 'none';
                    
                    // Only start countdown if there's actually time left
                    if (expiryTime > now) {
                        startExpiryCountdown(savedExpiry);
                    } else {
                        // Code just expired, show expired message directly
                        const statusEl = document.getElementById('joinCodeResult');
                        const expiryMsg = document.createElement('div');
                        expiryMsg.className = 'expiry-message';
                        expiryMsg.style.color = '#ef4444';
                        expiryMsg.style.marginTop = '12px';
                        expiryMsg.innerHTML = '‚ö†Ô∏è This code has expired. Please request a new one.';
                        statusEl.appendChild(expiryMsg);
                        
                        document.getElementById('joinCodeDisplay').classList.add('is-expired');
                        
                        const btn = document.getElementById('joinCodeBtn');
                        if (btn) {
                            btn.style.display = 'inline-block';
                            btn.textContent = 'Request New Code';
                        }
                    }
                } else {
                    // Code expired, clear session
                    sessionStorage.removeItem('blyan_join_code');
                    sessionStorage.removeItem('blyan_join_code_expires');
                }
            }
        });
        
    </script>
</body>
</html>