<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run a GPU Node - Blyan</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="shortcut icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="common-header-themed.css">
    <link rel="stylesheet" href="page-template.css">
    <script src="language.js"></script>
    <script src="wallet.js"></script>
    <script src="theme.js?v=2"></script>
    <style>
        /* Theme variables */
        :root {
            --color-primary: #1E3A8A;
            --color-primary-light: #2E4EAE;
            --color-primary-dark: #152C66;
            --color-secondary: #06B6D4;
            --color-secondary-light: #22D3EE;
            --color-secondary-dark: #0891B2;
            --color-background: #FFFFFF;
            --color-surface: #F9FAFB;
            --color-elevated: #FFFFFF;
            --color-text-primary: #111827;
            --color-text-secondary: #374151;
            --color-text-disabled: #9CA3AF;
            --color-divider: #E5E7EB;
            --color-action-hover: rgba(30, 58, 138, 0.08);
            --color-action-selected: rgba(30, 58, 138, 0.12);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.03);
            --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.12);
        }
        
        [data-theme="dark"] {
            --color-primary: #22D3EE;
            --color-primary-light: #67E8F9;
            --color-primary-dark: #06B6D4;
            --color-secondary: #2E4EAE;
            --color-secondary-light: #4361C2;
            --color-secondary-dark: #1E3A8A;
            --color-background: #111827;
            --color-surface: #1F2937;
            --color-elevated: #0F172A;
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #D1D5DB;
            --color-text-disabled: #4B5563;
            --color-divider: #374151;
            --color-action-hover: rgba(6, 182, 212, 0.12);
            --color-action-selected: rgba(6, 182, 212, 0.16);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.5);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--color-text-primary);
            background-color: var(--color-background);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
        }

        /* Tab styles */
        .tab-buttons {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--color-divider);
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            color: var(--color-primary);
        }

        .tab-button.active {
            color: var(--color-primary);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Requirements Grid */
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(145deg, var(--color-surface), var(--color-elevated));
            border-radius: 12px;
            border: 1px solid var(--color-divider);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .requirement-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            border-radius: 12px 12px 0 0;
        }
        
        .requirement-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .requirement-icon {
            font-size: 24px;
        }

        .requirement-text {
            flex: 1;
        }

        .requirement-label {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .requirement-value {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        /* Setup Steps */
        .setup-steps {
            counter-reset: step-counter;
            margin-top: 40px;
        }

        .setup-step {
            position: relative;
            padding: 24px;
            padding-left: 60px;
            margin-bottom: 24px;
            background: linear-gradient(145deg, var(--color-surface), var(--color-elevated));
            border-radius: 12px;
            border: 1px solid var(--color-divider);
            transition: all 0.3s ease;
        }
        
        .setup-step::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--color-primary), var(--color-secondary));
            border-radius: 12px 0 0 12px;
        }

        .setup-step:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .setup-step::before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-background);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            z-index: 1;
        }

        .step-title {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 8px;
        }

        .step-description {
            color: var(--color-text-secondary);
        }

        /* Code block */
        .code-block {
            background: var(--color-elevated);
            border: 1px solid var(--color-divider);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            color: var(--color-text-primary);
        }

        /* Modal styles for node key generation */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--color-elevated);
            color: var(--color-text-primary);
            width: min(720px, 90%);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0;
        }
        
        .modal-close {
            border: none;
            background: transparent;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 4px;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: var(--color-text-primary);
        }
        
        .modal-body {
            color: var(--color-text-secondary);
        }
        
        .modal-button {
            background: var(--color-primary);
            color: var(--color-background);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }
        
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: var(--color-background);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 0px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-divider);
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            color: var(--color-primary);
        }

        .collapsible-header .section-title {
            margin: 0;
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }

        .collapse-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            color: var(--color-text-secondary);
        }

        .collapsible-header:hover .collapse-icon {
            color: var(--color-primary);
        }

        .collapse-icon.rotated {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding-top: 20px;
            animation: slideDown 0.3s ease-out;
        }
        
        /* Join code states */
        .is-expired {
            opacity: 0.5;
            text-decoration: line-through;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <!-- Main Title Section -->
    <div class="feature-section" style="padding-top: 40px;">
        <div class="section-container">
            <div class="section-header">
                <h1 class="section-title">Run a GPU Node</h1>
                <p class="section-subtitle">Join the Blyan network and earn BLY tokens by contributing GPU power</p>
                <p style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.03); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    💡 <strong>Need API access?</strong> If you want to use the main API endpoints (not required for running a node), 
                    <a href="#api-key-section" style="color: var(--color-primary); text-decoration: underline;">see how to get an API key below</a>.
                </p>
            </div>

            <!-- Tab buttons -->
            <div class="tab-buttons" role="tablist" aria-label="Installation method">
                <button id="tab-docker" class="tab-button active" role="tab" aria-selected="true" aria-controls="docker-tab" tabindex="0" onclick="selectTab('docker')">
                    🐳 Docker (Recommended)
                </button>
                <button id="tab-source" class="tab-button" role="tab" aria-selected="false" aria-controls="source-tab" tabindex="-1" onclick="selectTab('source')">
                    📦 Source (Advanced)
                </button>
            </div>
        </div>
    </div>

    <!-- API Key Section -->
    <div class="feature-section" id="api-key-section" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.03), rgba(59, 130, 246, 0.03)); padding: 40px 0;">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">🔑 Get an API Key (for API usage)</h2>
                <p class="section-subtitle">API keys are for calling main API endpoints - NOT required to run a GPU node</p>
            </div>
            
            <div style="display: grid; gap: 24px;">
                <!-- When You Need an API Key -->
                <div style="padding: 24px; background: var(--color-elevated); border-radius: 12px; border: 1px solid var(--color-divider);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">📋 When You Need an API Key</h3>
                    <ul style="color: var(--color-text-secondary); margin: 12px 0;">
                        <li>Calling centralized API endpoints like <code>/chat</code> on the main server</li>
                        <li>Using the API programmatically from your applications</li>
                        <li>Accessing protected endpoints that require authentication</li>
                    </ul>
                    <p style="margin: 16px 0 0 0; padding: 12px; background: rgba(34, 197, 94, 0.03); border-radius: 6px;">
                        ✅ <strong>Note:</strong> API keys are NOT needed for node enrollment or running a GPU node. Nodes use JOIN_CODE for initial enrollment.
                    </p>
                </div>

                <!-- Create an API Key -->
                <div style="padding: 24px; background: var(--color-elevated); border-radius: 12px; border: 1px solid var(--color-divider);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">🚀 Create an API Key</h3>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Register a new API key with the authentication service:</p>
                    <div class="code-block">
curl -X POST https://api.blyan.com/auth/v2/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "my-api-key",
    "key_type": "basic",
    "metadata": {
      "purpose": "testing"
    }
  }'</div>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Response:</p>
                    <div class="code-block" style="background: rgba(34, 197, 94, 0.03);">{
  "api_key": "eyJhbGciOiJIUzI1NiIs...",
  "key_id": "key_abc123",
  "name": "my-api-key",
  "created_at": "2024-01-01T00:00:00Z"
}</div>
                    <p style="margin: 16px 0 0 0; padding: 12px; background: rgba(245, 158, 11, 0.03); border-radius: 6px;">
                        ⚠️ <strong>Important:</strong> Store your <code>api_key</code> securely. It's a JWT token that won't be shown again.
                    </p>
                </div>

                <!-- Validate Your Key -->
                <div style="padding: 24px; background: var(--color-elevated); border-radius: 12px; border: 1px solid var(--color-divider);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">✔️ Validate Your Key</h3>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Check if your API key is valid:</p>
                    <div class="code-block">
curl -X GET https://api.blyan.com/auth/v2/validate \
  -H "Authorization: Bearer YOUR_API_KEY"</div>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Success response (200 OK):</p>
                    <div class="code-block" style="background: rgba(34, 197, 94, 0.03);">{
  "valid": true,
  "key_id": "key_abc123",
  "name": "my-api-key",
  "roles": ["user"],
  "scopes": ["chat:read", "chat:write"]
}</div>
                </div>

                <!-- Refresh Your Key -->
                <div style="padding: 24px; background: var(--color-elevated); border-radius: 12px; border: 1px solid var(--color-divider);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">🔄 Refresh Your Key</h3>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Rotate your API key if it's been compromised or needs renewal:</p>
                    <div class="code-block">
curl -X POST https://api.blyan.com/auth/v2/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "current_key": "YOUR_CURRENT_API_KEY"
  }'</div>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Response contains a new <code>api_key</code> - update your applications immediately.</p>
                </div>

                <!-- Use Your API Key -->
                <div style="padding: 24px; background: var(--color-elevated); border-radius: 12px; border: 1px solid var(--color-divider);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">💬 Use Your API Key</h3>
                    <p style="color: var(--color-text-secondary); margin: 12px 0;">Example: Call the chat endpoint with your API key:</p>
                    <div class="code-block">
curl -X POST https://api.blyan.com/chat \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Hello, how are you?",
    "max_tokens": 50
  }'</div>
                    <p style="color: var(--color-text-secondary); margin: 16px 0;">Python example:</p>
                    <div class="code-block">import requests

api_key = "YOUR_API_KEY"
headers = {
    "Authorization": f"Bearer {api_key}",
    "Content-Type": "application/json"
}

response = requests.post(
    "https://api.blyan.com/chat",
    headers=headers,
    json={"prompt": "Hello", "max_tokens": 50}
)

print(response.json())</div>
                </div>

                <!-- Security Best Practices -->
                <div style="padding: 24px; background: rgba(220, 38, 38, 0.03); border-radius: 12px; border: 1px solid rgba(220, 38, 38, 0.2);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">🔒 Security Best Practices</h3>
                    <ul style="color: var(--color-text-secondary); margin: 12px 0;">
                        <li><strong>Never commit API keys</strong> to version control (use .env files)</li>
                        <li><strong>Never share keys</strong> between applications or users</li>
                        <li><strong>Rotate immediately</strong> if a key is exposed</li>
                        <li><strong>Use environment variables</strong> to store keys in production</li>
                        <li><strong>Monitor usage</strong> through the API metrics endpoints</li>
                        <li><strong>RBAC enforced</strong> - keys have specific roles and scopes limiting access</li>
                    </ul>
                    <div class="code-block" style="margin-top: 16px;">
# Good: Use environment variables
export BLYAN_API_KEY="your-api-key-here"
curl -H "Authorization: Bearer $BLYAN_API_KEY" ...

# Bad: Never hardcode keys
curl -H "Authorization: Bearer eyJhbGc..." ...</div>
                </div>

                <!-- Additional Notes -->
                <div style="padding: 24px; background: rgba(59, 130, 246, 0.03); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <h3 style="margin-top: 0; color: var(--color-text-primary); font-size: 1.2rem;">📝 Additional Notes</h3>
                    <ul style="color: var(--color-text-secondary); margin: 12px 0;">
                        <li>API keys use <strong>JWT (JSON Web Tokens)</strong> format</li>
                        <li>Always use <strong>Bearer authentication</strong> in the Authorization header</li>
                        <li>Keys may have <strong>expiration times</strong> - check the JWT payload</li>
                        <li>Different <strong>key types</strong> may have different rate limits and permissions</li>
                        <li>The <strong>main node</strong> (api.blyan.com) handles all API key operations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Prerequisites Section -->
    <div class="feature-section" style="padding-top: 20px;">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Prerequisites</h2>
                <p class="section-subtitle">What you need to run a node</p>
            </div>
            
            <div class="requirements-grid">
                <div class="requirement-item">
                    <span class="requirement-icon">🖥️</span>
                    <div class="requirement-text">
                        <div class="requirement-label">Hardware</div>
                        <div class="requirement-value">NVIDIA GPU (BF16 recommended), 12+ GB VRAM recommended. CPU works but slow.</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">🐧</span>
                    <div class="requirement-text">
                        <div class="requirement-label">Software (Docker)</div>
                        <div class="requirement-value">Linux/WSL2, NVIDIA Driver ≥525, CUDA 12, Docker + NVIDIA Container Toolkit</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">💾</span>
                    <div class="requirement-text">
                        <div class="requirement-label">Disk Space</div>
                        <div class="requirement-value">25-40 GB free in BLYAN_DATA_DIR (defaults to /data in Docker)</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">🌐</span>
                    <div class="requirement-text">
                        <div class="requirement-label">Network</div>
                        <div class="requirement-value">Open inbound TCP 8001, outbound HTTPS. Configure PUBLIC_HOST/PUBLIC_PORT behind NAT/proxy.</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">🔑</span>
                    <div class="requirement-text">
                        <div class="requirement-label">Credentials</div>
                        <div class="requirement-value">JOIN_CODE required only at first run. Credentials saved to /data/credentials.json (0600).</div>
                    </div>
                </div>
                <div class="requirement-item">
                    <span class="requirement-icon">🐍</span>
                    <div class="requirement-text">
                        <div class="requirement-label">Software (Source)</div>
                        <div class="requirement-value">Python 3.10-3.11, git, make/pip</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Docker Tab Content -->
    <div id="docker-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-docker">
        <div class="feature-section alt-background">
            <div class="section-container">
                <div class="section-header">
                    <h2 class="section-title">🚀 Docker Quick Start</h2>
                    <p class="section-subtitle">The easiest way to run a node</p>
                </div>
                
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-title">Get JOIN_CODE</div>
                        <div class="step-description">Request a one-time enrollment code (valid for 30 minutes)</div>
                        <div style="padding: 16px; background: rgba(59, 130, 246, 0.03); border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 12px;">
                            <button onclick="requestJoinCode()" style="
                                background: var(--color-primary);
                                color: var(--color-background);
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                margin-bottom: 12px;
                            " id="joinCodeBtn">
                                Request Join Code
                            </button>
                            <div id="joinCodeResult" style="display: none; margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.03); border-radius: 6px;">
                                <strong>Your Join Code:</strong> <code id="joinCodeDisplay" style="font-size: 1.2em; font-weight: bold;"></code><br>
                                <small style="color: var(--color-text-secondary);">Valid for 30 minutes. Use it in Step 3 below.</small>
                            </div>
                            <p style="margin-top: 12px; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <em>Note: Preview only - join code issuance not yet active in production</em>
                            </p>
                        </div>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Prepare directories and firewall</div>
                        <div class="step-description">Set up persistent storage and network security</div>
                        <div class="code-block">
                            # Create data directory for credentials and blockchain data<br>
                            sudo mkdir -p /var/lib/blyan/data<br>
                            sudo chmod 755 /var/lib/blyan<br>
                            sudo chown $USER:$USER /var/lib/blyan/data<br><br>
                            
                            # Configure firewall (if using UFW)<br>
                            sudo ufw allow 8001/tcp comment 'Blyan Node'<br>
                            sudo ufw --force enable
                        </div>
                        <p style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.03); border-radius: 6px;">
                            💡 <strong>Security Tip:</strong> Consider using a dedicated user account for running the node. The node runs as non-root inside the container.
                        </p>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Run the node</div>
                        <div class="step-description">Start your node with Docker (use your JOIN_CODE from Step 1)</div>
                        <div class="code-block">
                            docker run -d --name blyan-node \<br>
                            &nbsp;&nbsp;--gpus all \<br>
                            &nbsp;&nbsp;-p 8001:8001 \<br>
                            &nbsp;&nbsp;-v /var/lib/blyan/data:/data \<br>
                            &nbsp;&nbsp;-e JOIN_CODE=<span style="color: #ef4444;">YOUR_CODE_HERE</span> \<br>
                            &nbsp;&nbsp;-e MAIN_NODE_URL=https://api.blyan.com \<br>
                            &nbsp;&nbsp;-e PUBLIC_HOST=$(curl -s https://checkip.amazonaws.com) \<br>
                            &nbsp;&nbsp;-e PUBLIC_PORT=8001 \<br>
                            &nbsp;&nbsp;-e JOB_CAPACITY=1 \<br>
                            &nbsp;&nbsp;-e NODE_ENV=production \<br>
                            &nbsp;&nbsp;--restart unless-stopped \<br>
                            &nbsp;&nbsp;mnls0115/blyan-node:latest
                        </div>
                        <p style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.03); border-radius: 6px;">
                            💡 <strong>CPU-only note:</strong> Omit <code>--gpus all</code> if you don't have NVIDIA GPU/drivers.
                        </p>
                        <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.03); border-radius: 8px;">
                            <strong>Alternative:</strong> Use docker-compose for easier management
                            <div class="code-block" style="margin-top: 12px;">
                                # Prepare environment (first run only)<br>
                                export JOIN_CODE=YOUR_CODE_HERE<br>
                                export DATA_DIR=/var/lib/blyan/data  # optional override<br><br>

                                # Start services from docker-compose.yml<br>
                                docker-compose up -d
                            </div>
                            <small style="color: var(--color-text-secondary);">Tip: After first enrollment, you can unset JOIN_CODE; credentials are persisted in the data volume.</small>
                        </div>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Verify node status</div>
                        <div class="step-description">Check enrollment, model loading, and API readiness</div>
                        <div class="code-block">
                            # Check logs for enrollment success and model loading<br>
                            docker logs -f blyan-node<br>
                            # Look for: "Enrollment successful", "Model manager ready"<br><br>
                            
                            # Test health endpoint<br>
                            curl http://localhost:8001/health<br>
                            # Expect: {"status":"healthy","model_ready":true}<br><br>
                            
                            # Test inference (optional)<br>
                            curl -X POST http://localhost:8001/chat \<br>
                            &nbsp;&nbsp;-H 'Content-Type: application/json' \<br>
                            &nbsp;&nbsp;-d '{"prompt":"Hello","max_new_tokens":16}'<br><br>
                            
                            # Verify credentials are secure<br>
                            docker exec blyan-node ls -l /data/credentials.json<br>
                            # Should show: -rw------- (600 permissions)
                        </div>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Restarting your node</div>
                        <div class="step-description">No JOIN_CODE needed after first enrollment!</div>
                        <div class="code-block">
                            # Simple restart (uses saved credentials)<br>
                            docker restart blyan-node<br><br>
                            
                            # View logs after restart<br>
                            docker logs -f blyan-node
                        </div>
                        <p style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.03); border-radius: 6px;">
                            ✅ After first enrollment, your node has permanent credentials in <code>/data/credentials.json</code>. These are loaded automatically on every restart.
                        </p>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <div style="margin-top: 40px; padding: 24px; background: rgba(245, 158, 11, 0.03); border-radius: 12px;">
                    <h3 style="margin-top: 0; color: var(--color-text-primary);">⚠️ Troubleshooting</h3>
                    <ul style="color: var(--color-text-secondary);">
                        <li><strong>Port in use:</strong> Change <code>-p 8001:8001</code> to <code>-p 8002:8001</code> to use port 8002</li>
                        <li><strong>JOIN_CODE expired:</strong> Request a new code (they expire after 30 minutes)</li>
                        <li><strong>Behind NAT:</strong> Ensure port forwarding is configured and PUBLIC_HOST is set correctly</li>
                        <li><strong>VRAM OOM:</strong> Lower JOB_CAPACITY to 0 or remove GPU flag</li>
                        <li><strong>Redis warnings:</strong> These are OK for nodes - only the main server needs Redis</li>
                    </ul>
                </div>

                <!-- What Happens After Connection -->
                <div style="margin-top: 40px; padding: 24px; background: rgba(59, 130, 246, 0.03); border-radius: 12px;">
                    <h3 style="margin-top: 0; color: var(--color-text-primary);">🔄 What Happens After Connection</h3>
                    <ul style="color: var(--color-text-secondary);">
                        <li><strong>Enrollment:</strong> Node calls <code>/api/p2p/enroll</code> with JOIN_CODE → receives node_id/node_key</li>
                        <li><strong>Registration:</strong> Node calls <code>/api/p2p/register</code> with GPU info and capacity</li>
                        <li><strong>Parameter sync:</strong> Param index rebuild and potential auto-upload (if AUTO_UPLOAD=true)</li>
                        <li><strong>Model manager:</strong> Loads model from blockchain-first, uses BF16 precision, no local/HF models in production</li>
                        <li><strong>API ready:</strong> Node serves on :8001 with endpoints: /health, /metrics, /chat</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Tab Content -->
    <div id="source-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-source">
        <div class="feature-section alt-background">
            <div class="section-container">
                <div class="section-header">
                    <h2 class="section-title">📦 Source Installation (Advanced)</h2>
                    <p class="section-subtitle">Run directly from source code for development</p>
                </div>
                
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-title">Clone and install</div>
                        <div class="step-description">Get the source code and set up dependencies</div>
                        <div class="code-block">
                            # Clone repository<br>
                            git clone https://github.com/mnls0115/Blyan.git<br>
                            cd Blyan<br><br>
                            
                            # Create virtual environment<br>
                            python3 -m venv .venv<br>
                            source .venv/bin/activate<br><br>
                            
                            # Install dependencies<br>
                            make install<br>
                            # Or: pip install -r requirements.txt
                        </div>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Configure environment</div>
                        <div class="step-description">Set up environment variables for development</div>
                        <div class="code-block">
                            # Basic configuration<br>
                            export NODE_ENV=development<br>
                            export BLYAN_DATA_DIR=./data<br>
                            export MAIN_NODE_URL=http://127.0.0.1:8000<br>
                            export JOB_CAPACITY=1<br><br>
                            
                            # Development flags (optional)<br>
                            export SKIP_POW=true  # Skip proof-of-work in dev<br>
                            export ENABLE_POL=true  # Enable proof-of-learning<br><br>
                            
                            # For first run, you need JOIN_CODE<br>
                            export JOIN_CODE=YOUR_CODE_HERE
                        </div>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Start services</div>
                        <div class="step-description">Run the API server and GPU node</div>
                        <div class="code-block">
                            # Start API server (optional, for local testing)<br>
                            python -m api.server<br><br>
                            
                            # In another terminal, start the GPU node<br>
                            python run_gpu_node.py
                        </div>
                    </div>

                    <div class="setup-step">
                        <div class="step-title">Verify operation</div>
                        <div class="step-description">Check that everything is working</div>
                        <div class="code-block">
                            # Test health endpoint<br>
                            curl http://localhost:8001/health<br><br>
                            
                            # Test inference<br>
                            curl -X POST http://localhost:8001/chat \<br>
                            &nbsp;&nbsp;-H 'Content-Type: application/json' \<br>
                            &nbsp;&nbsp;-d '{"prompt":"Hello","max_new_tokens":16}'<br><br>
                            
                            # Check credentials<br>
                            ls -la ./data/credentials.json
                        </div>
                    </div>
                </div>

                <div style="margin-top: 40px; padding: 24px; background: rgba(245, 158, 11, 0.03); border-radius: 12px;">
                    <h3 style="margin-top: 0; color: var(--color-text-primary);">📝 Development Notes</h3>
                    <ul style="color: var(--color-text-secondary);">
                        <li>Use <code>NODE_ENV=development</code> for verbose logging</li>
                        <li>The API server is optional - nodes can connect to remote main server</li>
                        <li>Credentials are saved to <code>BLYAN_DATA_DIR/credentials.json</code></li>
                        <li>Set <code>SKIP_POW=true</code> to bypass proof-of-work in development</li>
                        <li>Monitor GPU memory with <code>nvidia-smi -l 1</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Common Concepts Section -->
    <div class="feature-section" id="common-concepts">
        <div class="section-container">
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('common-concepts-content')">
                    <div>
                        <h2 class="section-title">📚 Common Concepts</h2>
                        <p class="section-subtitle">Essential information for all installation methods</p>
                    </div>
                    <span class="collapse-icon" id="common-concepts-content-icon">▼</span>
                </div>
                <div class="collapsible-content" id="common-concepts-content" style="display: none;">
                    
                    <!-- Environment Variables -->
                    <div style="margin-bottom: 24px; padding: 20px; background: rgba(59, 130, 246, 0.03); border-radius: 8px;">
                        <h3 style="margin-top: 0; color: var(--color-text-primary);">🔧 Environment Variables</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">JOIN_CODE</td>
                                <td style="padding: 8px;">One-time enrollment code (first run only)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">BLYAN_DATA_DIR</td>
                                <td style="padding: 8px;">Data directory for blockchain and credentials</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">MAIN_NODE_URL</td>
                                <td style="padding: 8px;">Main server URL (default: https://api.blyan.com)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">PUBLIC_HOST</td>
                                <td style="padding: 8px;">Your public IP address for P2P connections</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">PUBLIC_PORT</td>
                                <td style="padding: 8px;">Public port for your node (default: 8001)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">JOB_CAPACITY</td>
                                <td style="padding: 8px;">Number of concurrent jobs (0-10, based on VRAM)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">NODE_ENV</td>
                                <td style="padding: 8px;">production or development</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--color-divider);">
                                <td style="padding: 8px; font-weight: 600;">SKIP_POW</td>
                                <td style="padding: 8px;">(Dev only) Skip proof-of-work validation</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">ENABLE_POL</td>
                                <td style="padding: 8px;">(Dev only) Enable proof-of-learning</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Credential Flow -->
                    <div style="margin-bottom: 24px; padding: 20px; background: rgba(34, 197, 94, 0.03); border-radius: 8px;">
                        <h3 style="margin-top: 0; color: var(--color-text-primary);">🔑 Authentication Flow</h3>
                        <ol style="color: var(--color-text-secondary);">
                            <li><strong>Request JOIN_CODE:</strong> Get a one-time code (valid 30 minutes)</li>
                            <li><strong>First boot:</strong> Node exchanges JOIN_CODE for permanent credentials</li>
                            <li><strong>Credentials stored:</strong> Saved to /data/credentials.json with 0600 permissions</li>
                            <li><strong>Future restarts:</strong> Node uses stored credentials automatically</li>
                        </ol>
                        <p style="margin-top: 16px; padding: 12px; background: rgba(220, 38, 38, 0.03); border-radius: 6px;">
                            ⚠️ <strong>Security:</strong> Never share or commit credentials.json. It contains your node's private key.
                        </p>
                    </div>

                    <!-- API Endpoints -->
                    <div style="margin-bottom: 24px; padding: 20px; background: rgba(245, 158, 11, 0.03); border-radius: 8px;">
                        <h3 style="margin-top: 0; color: var(--color-text-primary);">🌐 Key Endpoints</h3>
                        <ul style="color: var(--color-text-secondary);">
                            <li><code>GET /health</code> - Node health status</li>
                            <li><code>GET /metrics</code> - Performance metrics</li>
                            <li><code>POST /chat</code> - Inference endpoint</li>
                            <li><code>POST /api/p2p/enroll</code> - Initial enrollment (automatic)</li>
                            <li><code>POST /api/p2p/register</code> - Register GPU capabilities (automatic)</li>
                        </ul>
                    </div>

                    <!-- JOIN_CODE Note -->
                    <div style="padding: 20px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 2px solid rgba(59, 130, 246, 0.3);">
                        <h3 style="margin-top: 0; color: var(--color-text-primary);">📌 Important Note</h3>
                        <p style="color: var(--color-text-secondary); margin: 0;">
                            The JOIN_CODE system is currently in preview mode. Production code generation via <code>/api/p2p/join-code</code> 
                            will be enabled when the network officially launches. For now, you can test the flow with mock codes.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Start Modal -->
    <div id="joinModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quick Start Guide</h3>
                <button id="joinClose" class="modal-close" aria-label="Close modal">✖</button>
            </div>
            <div id="joinBody" class="modal-body">
                <p>Docker quick reference for running a node:</p>
                
                <div class="code-block">
                    docker run -d --name blyan-node \<br>
                    &nbsp;&nbsp;--gpus all \<br>
                    &nbsp;&nbsp;-p 8001:8001 \<br>
                    &nbsp;&nbsp;-v /var/lib/blyan/data:/data \<br>
                    &nbsp;&nbsp;-e JOIN_CODE=YOUR_CODE_HERE \<br>
                    &nbsp;&nbsp;-e MAIN_NODE_URL=https://api.blyan.com \<br>
                    &nbsp;&nbsp;-e PUBLIC_HOST=$(curl -s https://checkip.amazonaws.com) \<br>
                    &nbsp;&nbsp;-e PUBLIC_PORT=8001 \<br>
                    &nbsp;&nbsp;-e JOB_CAPACITY=1 \<br>
                    &nbsp;&nbsp;-e NODE_ENV=production \<br>
                    &nbsp;&nbsp;--restart unless-stopped \<br>
                    &nbsp;&nbsp;mnls0115/blyan-node:latest
                </div>
                
                <p style="margin-top:20px; padding: 16px; background: rgba(34, 197, 94, 0.03); border-radius: 8px;">
                    ✅ Remember: JOIN_CODE is only needed for first enrollment. Future restarts use stored credentials automatically.
                </p>
            </div>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <span id="themeIcon">🌙</span>
    </button>

    <script src="config.js?v=7"></script>
    <script src="api-auth.js?v=2"></script>
    <script src="common-header.js?v=7"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Create header
            document.getElementById('header-container').innerHTML = createAIBlockHeader('contribute');
            
            // Theme toggle functionality
            document.getElementById('themeToggle').addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            // Wire modal close button
            document.getElementById('joinClose').addEventListener('click', () => {
                document.getElementById('joinModal').style.display = 'none';
            });
        });
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            icon.textContent = theme === 'light' ? '🌙' : '☀️';
        }

        function openJoinModal() {
            document.getElementById('joinModal').style.display = 'flex';
        }

        function selectTab(tab) {
            // Update buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
                btn.setAttribute('tabindex', '-1');
            });
            
            // Update content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            if (tab === 'docker') {
                const btn = document.getElementById('tab-docker');
                const panel = document.getElementById('docker-tab');
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
                btn.setAttribute('tabindex', '0');
                panel.classList.add('active');
            } else {
                const btn = document.getElementById('tab-source');
                const panel = document.getElementById('source-tab');
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
                btn.setAttribute('tabindex', '0');
                panel.classList.add('active');
            }
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.classList.add('rotated');
                icon.textContent = '▲';
            } else {
                content.style.display = 'none';
                icon.classList.remove('rotated');
                icon.textContent = '▼';
            }
        }
        
        async function requestJoinCode() {
            const btn = document.getElementById('joinCodeBtn');
            const resultDiv = document.getElementById('joinCodeResult');
            const codeDisplay = document.getElementById('joinCodeDisplay');
            const note = document.querySelector('#joinCodeBtn')?.parentElement?.querySelector('p em');
            
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            // Try production API first
            try {
                const apiBase = (window.API_CONFIG && API_CONFIG.baseURL) ? API_CONFIG.baseURL : '/api';
                const response = await fetch(`${apiBase}/p2p/join-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ node_type: 'gpu' })
                });
                if (response.ok) {
                    const data = await response.json();
                    codeDisplay.textContent = data.join_code;
                    resultDiv.style.display = 'block';
                    btn.style.display = 'none';
                    const expires = Date.parse(data.expires_at);
                    if (!isNaN(expires)) startExpiryCountdown(expires);
                    if (note) note.textContent = 'Join code issued by API (production)';
                    return;
                }
            } catch (e) {
                console.warn('Join-code API unavailable, using preview code:', e);
            }

            // Fallback to preview mock code
            const mockCode = 'PREVIEW-' + Math.random().toString(36).substring(2, 10).toUpperCase();
            codeDisplay.textContent = mockCode;
            resultDiv.style.display = 'block';
            btn.style.display = 'none';
            startExpiryCountdown(Date.now() + 30 * 60 * 1000);
            if (note) note.textContent = 'Preview only - join code issuance not yet active in production';
        }
        
        let countdownInterval = null;
        
        function startExpiryCountdown(expiresAt) {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const tick = () => {
                const now = Date.now();
                const left = expiresAt - now;
                
                if (left <= 0) {
                    document.getElementById('joinCodeDisplay').classList.add('is-expired');
                    document.getElementById('joinCodeBtn').style.display = 'inline-block';
                    document.getElementById('joinCodeBtn').textContent = 'Request New Code';
                    document.getElementById('joinCodeBtn').disabled = false;
                    clearInterval(countdownInterval);
                    return;
                }
                
                const minutes = Math.floor(left / 60000);
                const seconds = Math.floor((left % 60000) / 1000);
                
                const timerText = ` (${minutes}m ${seconds}s remaining)`;
                const smallEl = document.querySelector('#joinCodeResult small');
                if (smallEl && !smallEl.querySelector('.timer')) {
                    const timerSpan = document.createElement('span');
                    timerSpan.className = 'timer';
                    timerSpan.style.marginLeft = '10px';
                    smallEl.appendChild(timerSpan);
                }
                const timerEl = document.querySelector('.timer');
                if (timerEl) timerEl.textContent = timerText;
            };
            
            countdownInterval = setInterval(tick, 1000);
            tick();
        }
    </script>
</body>
</html>
