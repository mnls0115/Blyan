version: '3.8'

services:
  blyan-node:
    # Use pre-built image or build from source
    image: mnls0115/blyan-node:latest
    # Uncomment to build from source instead:
    # build:
    #   context: .
    #   dockerfile: docker/Dockerfile.gpu
    container_name: blyan-node
    restart: unless-stopped
    ports:
      - "8001:8001"
    volumes:
      - /var/lib/blyan/data:/data
    environment:
      # Required for first run only (get from https://blyan.com/contribute)
      - JOIN_CODE=${JOIN_CODE}
      
      # Main node URL (default: production)
      - MAIN_NODE_URL=${MAIN_NODE_URL:-https://api.blyan.com}
      
      # Public connectivity
      - PUBLIC_HOST=${PUBLIC_HOST}
      - PUBLIC_PORT=${PUBLIC_PORT:-8001}
      
      # Node configuration
      - JOB_CAPACITY=${JOB_CAPACITY:-1}
      - NODE_ENV=${NODE_ENV:-production}
      
      # Optional: Skip proof-of-work in development
      - SKIP_POW=${SKIP_POW:-false}
      - ENABLE_POL=${ENABLE_POL:-false}
      
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - blyan-network

  # Optional: Local Redis for caching (comment out if not needed)
  redis:
    image: redis:7-alpine
    container_name: blyan-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    command: redis-server --save 60 1 --loglevel warning
    networks:
      - blyan-network

volumes:
  redis-data:
    driver: local

networks:
  blyan-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
