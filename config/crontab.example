# Blyan Network Backup Crontab Configuration
# 
# Installation:
# 1. Copy this file: cp config/crontab.example /etc/cron.d/blyan-backup
# 2. Set environment variables in /etc/environment or systemd service
# 3. Reload cron: systemctl reload cron
#
# Format: MIN HOUR DOM MON DOW USER COMMAND

# Environment (adjust paths as needed)
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DB_HOST=localhost
DB_NAME=blyan_db
DB_USER=blyan_user
BACKUP_DIR=/var/backups/blyan
SLACK_WEBHOOK=https://hooks.slack.com/services/YOUR/WEBHOOK/URL

# Hourly backup (every hour at :15)
15 * * * * blyan /opt/blyan/scripts/backup_postgres.sh hourly >> /var/log/blyan_backup.log 2>&1

# Daily backup (every day at 2:30 AM)
30 2 * * * blyan /opt/blyan/scripts/backup_postgres.sh daily >> /var/log/blyan_backup.log 2>&1

# Weekly backup (every Sunday at 3:00 AM)
0 3 * * 0 blyan /opt/blyan/scripts/backup_postgres.sh weekly >> /var/log/blyan_backup.log 2>&1

# Disaster Recovery Rehearsal (every Wednesday at 4:00 AM)
0 4 * * 3 blyan /opt/blyan/scripts/restore_rehearsal.sh daily >> /var/log/blyan_restore.log 2>&1

# Monitoring health check (every 5 minutes)
*/5 * * * * blyan curl -f -s http://localhost:8000/health || echo "Health check failed at $(date)" | mail -s "Blyan Health Alert" ops@blyan.network

# Log rotation (monthly)
0 0 1 * * blyan find /var/log -name "blyan_*.log" -size +100M -exec gzip {} \; -exec mv {}.gz /var/log/archive/ \;

# Database maintenance (weekly vacuum and analyze)
0 5 * * 0 blyan psql -U blyan_user -d blyan_db -c "VACUUM ANALYZE;" >> /var/log/blyan_maintenance.log 2>&1

# Backup cleanup (daily at 6:00 AM - remove backups older than retention period)
0 6 * * * blyan find /var/backups/blyan/hourly -name "*.sql.gz" -mtime +2 -delete
0 6 * * * blyan find /var/backups/blyan/daily -name "*.sql.gz" -mtime +30 -delete
0 6 * * * blyan find /var/backups/blyan/weekly -name "*.sql.gz" -mtime +90 -delete