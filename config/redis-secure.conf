# Redis Security Configuration for Blyan GPU Node Manager
# This configuration enables authentication, ACLs, and TLS for production

# Basic Security
################################

# Require password for all connections
requirepass ${REDIS_PASSWORD}

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""

# Network Security
################################

# Bind to specific interfaces only (not 0.0.0.0)
bind 127.0.0.1 ::1

# Enable protected mode
protected-mode yes

# Set timeout for idle clients (5 minutes)
timeout 300

# TCP keepalive (detect dead peers)
tcp-keepalive 60

# TLS/SSL Configuration
################################

# Enable TLS port
tls-port 6380
port 0  # Disable non-TLS port in production

# TLS certificate and key
tls-cert-file /etc/redis/certs/redis.crt
tls-key-file /etc/redis/certs/redis.key

# Certificate authority
tls-ca-cert-file /etc/redis/certs/ca.crt

# DH parameters for perfect forward secrecy
tls-dh-params-file /etc/redis/certs/redis.dh

# TLS protocols (TLS 1.2 minimum)
tls-protocols "TLSv1.2 TLSv1.3"

# Cipher suite configuration
tls-ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256

# Prefer server cipher order
tls-prefer-server-ciphers yes

# Session caching
tls-session-caching yes
tls-session-cache-timeout 300

# ACL Configuration
################################

# Load ACL rules from file
aclfile /etc/redis/users.acl

# Persistence Security
################################

# AOF with fsync every second
appendonly yes
appendfsync everysec

# Disable auto AOF rewrite in production (manual control)
auto-aof-rewrite-percentage 0

# RDB checksum
rdbchecksum yes

# Memory Security
################################

# Max memory policy
maxmemory 2gb
maxmemory-policy allkeys-lru

# Logging
################################

# Log level
loglevel notice

# Log file
logfile /var/log/redis/redis-secure.log

# Syslog
syslog-enabled yes
syslog-ident redis-blyan

# Slow log
slowlog-log-slower-than 10000
slowlog-max-len 512